<html>

<head>
    <title>~ADMIN~ Undercover Nerd</title>

    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    
    <!-- <link rel="stylesheet" media="all" href="css/styles.css"> -->
    <style>
        body {
            background-color: rgba(25,40,120,0.7);
            margin: 5% 0 0 0;
            font-family: 'Roboto', sans-serif !important;
            color: white;
        }

        #pod-up-box {
            transform: translateX(-110%);
        }

        .option-button {
            width: 100%; 
            background-color: rgb(205,105,155);
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            margin: auto;
            border: none;
            opacity: 0.8;
            color: rgba(25,40,120,0.7);
        }

        .option-button:hover {
            cursor: pointer;
        }

        .form-box {
            width: 100%;
            max-height: 0;
            overflow: hidden;
            text-align: center;
            transition: all 1s;
        }

        #up-new-box.form-box.expand-form-box {
            max-height: 500px;
        }

        #up-new-live-box.form-box.expand-form-box {
            max-height: 1000px;
        }

        .form-box.expand-form-box {
            max-height: 60px;
            margin-bottom: 20px;
        }

        .form-box.expand-form-box.select-full-expand {
            max-height: 1000px;
        }

        .file-up-form {
            width: 100%;
            margin: auto;
        }

        #name-suggestion {
            width: 100%;
            margin: 10px auto;
        }

        .file-select-btn {
            margin: 20px 0;
        }

        .ex-pod-select-box {
            width: 250px;
            margin: 20px auto 20px auto;
        }

        #ex-pod-select {
            transition: transform 0.5s;
        }

        #item-explicit {
            margin: 5px 0;
        }

        #up-ex-select-box input, #up-new-select-box input {
            margin: 10px auto;
            display: block;
            line-height: 60px;
            text-align: center;
            width: 100%;
            background-color: rgba(0,0,0,0);
            color: white;
            border: none;
            font-size: 30px;
        }

        #up-ex-select-box input::placeholder, #up-new-select-box input::placeholder {
            color: rgb(205,105,155);
        }

        #test-audio, .test-audio-title, #make-it-live {
            display: none;
            margin: 30px auto;
            text-align: center;
        }

        body.new-pod-ready #test-audio, body.new-pod-ready .test-audio-title, body.new-pod-ready #make-it-live {
            display: block;
        }

        body.new-pod-submit #submit-new-file, body.new-pod-submit #up-new-btn, body.new-pod-submit .file-up-form, body.new-pod-submit #name-suggestion, body.new-pod-submit #up-ex-box, body.new-pod-submit #up-ex-btn {
            display: none;
        }
    </style>
</head>

<body>
    <div id="up-new-btn" class="option-button">new</div>
    <div id="up-new-box" class="form-box">
        <div id="name-suggestion"></div>
        <form class="file-up-form" method="POST" action="/admin/send/pod" >
            <input class="file-select-btn" type="file" name="myFile" id="myFile" required />
            <!-- <input class="file-up-btn option-button" type="submit" value="go" /> -->
        </form>
        <div id="submit-new-file" class="file-up-btn option-button">go</div>
        <div class="test-audio-title">see if it works: </div>
        <audio controls id="test-audio" src="" type="audio/mpeg"></audio>
        <div id="make-it-live" class="option-button">make it live</div>
    </div>
    <div id="up-ex-btn" class="option-button">old</div>
    <div id="up-ex-box" class="form-box">
        <div id="up-ex-select-in"></div>
        <div id="up-ex-select-box">
            <input id="item-title" type="text" placeholder="Title" />
            <input id="item-desc" type="text" placeholder="Description" />
            <input id="item-pubDate" type="text" placeholder="mm/dd/yyyy" />
            <input id="item-author" type="text" placeholder="Author" />
            <input id="item-link" type="text" placeholder="Link" />
            <input id="item-duration" type="text" placeholder="Duration 00:00:00" />
            <select id="item-explicit" placeholder="Explicit">
                <option value="" disabled="" selected="" hidden="hidden">Explicit?</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
            <input id="item-guid" type="text" placeholder="guid (same as link)" />
            <input id="item-enclosure" type="text" placeholder="mp3 URL" />
            <div id="up-ex-submit-btn" class="option-button">></div>
        </div>
    </div>
    <div id="up-new-live-box" class="form-box">
        <div id="up-new-select-box">
            <input id="new-item-title" type="text" placeholder="Title" />
            <input id="mew-item-desc" type="text" placeholder="Description" />
            <input id="new-item-pubDate" type="text" placeholder="mm/dd/yyyy" />
            <input id="new-item-author" type="text" placeholder="Author" />
            <input id="new-tem-link" type="text" placeholder="link: https://undercovercast.com/e=episodenumber" />
            <input id="new-item-duration" type="text" placeholder="Duration 00:00:00" />
            <select id="new-item-explicit" placeholder="Explicit">
                <option value="" disabled="" selected="" hidden="hidden">Explicit?</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
            <input id="new-item-guid" type="text" placeholder="guid (same as link)" />
            <!-- <input id="new-item-enclosure" type="text" placeholder="mp3 URL" /> -->
            <div id="up-new-submit-btn" class="option-button">></div>
        </div>
    </div>

    <script>
        var upNewBtn = document.getElementById('up-new-btn');
        var upExBtn = document.getElementById('up-ex-btn');
        var upNewBox = document.getElementById('up-new-box');
        var upExBox = document.getElementById('up-ex-box');
        var upExSubmit = document.getElementById('up-ex-submit-btn');
        var testAudio = document.getElementById ('test-audio');
        var upNewSubmit = document.getElementById ('up-new-submit-btn');
        var upNewBox = document.getElementById('up-new-live-box');
        var makeItLive = document.getElementById('make-it-live');

        var jData = {};
        var newFileName = '';

        var getJSON = function(url, successHandler, errorHandler) {
            var xhr = typeof XMLHttpRequest != 'undefined'
                ? new XMLHttpRequest()
                : new ActiveXObject('Microsoft.XMLHTTP');
            xhr.open('get', url, true);
            xhr.onreadystatechange = function() {
                var status; var data;
                if (xhr.readyState == 4) { // `DONE`
                    status = xhr.status;
                    if (status == 200) {
                        data = JSON.parse(xhr.responseText);
                        successHandler && successHandler(data);
                    } else { errorHandler && errorHandler(status); }
                }
            };
            xhr.send();
        };

        getJSON('/test.json', function(data) {
            console.log('Get success: ' , data);
            jData = data;

            var updateHTML = '';
            updateHTML = '<div class="ex-pod-select-box"><select id="ex-pod-select"><option value="" disabled="" selected="" hidden="hidden">Select Podcast to Edit:</option>';
                
            for(var i=0; i < jData.item.length; i++){
                updateHTML += '<option value="'+i+'">'+ i +': '+ jData.item[i].title +'</option>';
            }

            updateHTML += '</select></div>';

            document.getElementById('up-ex-select-in').innerHTML += updateHTML;
            
            var exPodSelect = document.getElementById('ex-pod-select');
            exPodSelect.addEventListener('change', function(){
                document.getElementById('up-ex-box').classList.add('select-full-expand');
            });

            var nameSuggestion = 'Should probably be titled: '+ jData.item.length + '.mp3';

            document.getElementById('name-suggestion').innerHTML = nameSuggestion;
        }, function(status) {
            console.log('Something went wrong.');
        });

        upNewBtn.addEventListener('click', function(){
            document.getElementById('up-new-box').classList.add('expand-form-box');
            document.getElementById('up-ex-box').classList.remove('expand-form-box');
        });
        upExBtn.addEventListener('click', function(){
            document.getElementById('up-new-box').classList.remove('expand-form-box');
            document.getElementById('up-ex-box').classList.add('expand-form-box');
        });

        // document.getElementById("myFile").onchange = () => {
        document.getElementById('submit-new-file').onclick = () => {
            document.body.classList.add('new-pod-submit');

            const files = document.getElementById('myFile').files;
            const file = files[0];
            if(file == null){
                return alert('No file selected.');
            }
            getSignedRequest(file);
        };

        function getSignedRequest(file){
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `/sign-s3?file-name=${file.name}&file-type=${file.type}`);
            xhr.onreadystatechange = () => {
                if(xhr.readyState === 4){
                    if(xhr.status === 200){
                        const response = JSON.parse(xhr.responseText);
                        uploadFile(file, response.signedRequest, response.url);
                    }
                    else{alert('Could not get signed URL.');}
                }
            };
            xhr.send();
        }

        function uploadFile(file, signedRequest, url){
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', signedRequest);
            xhr.onreadystatechange = () => {
                if(xhr.readyState === 4){
                    if(xhr.status === 200){
                        console.log(url);
                        document.body.classList.add('new-pod-submit');
                        testAudio.src = url;
                        document.body.classList.add('new-pod-ready');
                    }
                    else {
                        alert('Could not upload file - reload and try again');
                        document.body.classList.remove('new-pod-submit');
                        document.body.classList.remove('new-pod-ready');
                    }
                }
            };
            xhr.send(file);
        }

        upExSubmit.addEventListener('click', function(){
            var item = document.getElementById('ex-pod-select').value;
            var title = document.getElementById('item-title').value;
            var description = document.getElementById('item-desc').value;
            var pubDate = document.getElementById('item-pubDate').value;
            var author = document.getElementById('item-author').value;
            var link = document.getElementById('item-link').value;
            var duration = document.getElementById('item-duration').value;
            var explicit = document.getElementById('item-explicit').value;
            var guid = document.getElementById('item-guid').value;
            var enclosure = document.getElementById('item-enclosure').value;

            window.location.replace('https://undercovercast.com/admin/send?item='+item+'&title='+title+
                                '&description='+description+'&pubDate='+pubDate+'&author='+
                                author+'&link='+link+'&duration='+duration+'&explicit='+
                                explicit+'&guid='+guid+'&enclosure='+enclosure);
        });

        makeItLive.addEventListener('click', function(){
            upNewBox.classList.add('expand-form-box');
        });

        upNewSubmit.addEventListener('click', function(){
            var item = document.getElementById('ex-pod-select').value;
            var title = document.getElementById('item-title').value;
            var description = document.getElementById('item-desc').value;
            var pubDate = document.getElementById('item-pubDate').value;
            var author = document.getElementById('item-author').value;
            var link = document.getElementById('item-link').value;
            var duration = document.getElementById('item-duration').value;
            var explicit = document.getElementById('item-explicit').value;
            var guid = document.getElementById('item-guid').value;
            var enclosure = testAudio.src;

            window.location.replace('https://undercovercast.com/admin/send?item='+item+'&title='+title+
                                '&description='+description+'&pubDate='+pubDate+'&author='+
                                author+'&link='+link+'&duration='+duration+'&explicit='+
                                explicit+'&guid='+guid+'&enclosure='+enclosure);
        });
    </script>
</body>

</html>